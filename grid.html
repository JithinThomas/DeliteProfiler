<html>
	<head>
		<title>Layout test</title>
	</head>
	<body>
		<link rel="stylesheet" type="text/css" href="styles/grid.css" />
    	<link rel="stylesheet" type="text/css" href="styles/sidebar.css" />
	  	<link rel="stylesheet" type="text/css" href="styles/editor.css">
	  	<link rel="stylesheet" type="text/css" href="styles/dataflow.css">
	  	<link rel="stylesheet" type="text/css" href="styles/timeline.css">

	  	<div id="container">
			<div id="accordian">
				<ul>
					<li class="active">
						<h3>Inputs</h3>
						<ul>
							<li>
								<a href="#">
									<input type="button" value="Choose src dir        " onclick="document.getElementById('srcDirInput').click();" />
									<input type="file" id="srcDirInput" name="files[]"  multiple webkitdirectory="" directory="" style="display: none;" />
								</a>
							</li>
							<li>
								<a href="#">
									<input type="button" value="Choose DEG file      " onclick="document.getElementById('degFileInput').click();" />
									<input type="file" id="degFileInput" name="files[]" style="display: none;" />
								</a>
							</li>
							<li>
								<a href="#">
									<input type="button" value="Choose profile data" onclick="document.getElementById('profDataInput').click();" />
									<input type="file" id="profDataInput" name="files[]" style="display: none;" />
								</a>
							</li>
							<li>
								<a href="#">
									<button type="button" id="startButton"/>View</button>
								</a>
							</li>
						</ul>
					</li>
					<li class="active">
						<h3>DFG</h3>
						<ul>
							<li>
								<a href="#">
									<span>Color Scheme</span>	
									<select id="colorSchemeForGraph">
										<option value="datadeps">Data Deps</option>
										<option value="time">Exec Time</option>
										<option value="memUsage">Mem Usage</option>
									</select>
								</a>
							</li>
						</ul>
					</li>
					<li class="active">
						<h3>Timeline</h3>
						<ul>
							<li>
								<a href="#">
									<span>Level Filter</span>	
									<select id="timelineLevelFilter">
										<option value="0">Level 0</option>
										<option value="1">Level 1</option>
										<option value="2">Level 2</option>
									</select>
								</a>
							</li>
							<li>
								<a href="#">
									<span>Zoom </span>
									<input type="text" id="timelineZoom" size="5" value="100" style="text-align: right"> %
								</a>
							</li>
						</ul>
					</li>
					<li class="active">
						<h3>Kernel Info</h3>
						<ul>
							<li>
								<table id="kernelInfoTable" class="sidebarTable">
									<th>Property</th>
									<th>Value</th> 
									<tr>
										<td>Name</td>
										<td></td> 
									</tr>
									<tr>
										<td>Type</td>
										<td></td> 
									</tr>
									<tr>
										<td>Target</td>
										<td></td> 
									</tr>
									<tr>
										<td>Time (%)</td>
										<td></td> 
									</tr>
									<tr>
										<td>Exec/Sync Time (%)</td>
										<td></td> 
									</tr>
									<tr>
										<td>Mem Usage (B)</td>
										<td></td> 
									</tr>
								</table>
							</li>
						</ul>	
					<li class="active">
						<h3>Sync Node Info</h3>
						<ul>
							<li>
								<table id="syncNodeInfoTable" class="sidebarTable">
									<th>Property</th>
									<th>Value</th> 
									<tr>
										<td>Dep. Thread</td>
										<td></td> 
									</tr>
									<tr>
										<td>Dep. Kernel</td>
										<td></td> 
									</tr>
									<tr>
										<td>Time (%)</td>
										<td></td> 
									</tr>
								</table>
							</li>
						</ul>
					</li>
				</ul>
			</div>
			<div id="right">
				<div id="code"></div>
				<div id="dfg">
				</div>
				<div id="timeline"></div>
			</div>
		</div>

		<!-- external libraries -->
        <script type="text/javascript" src="../jquery/dist/jquery.min.js"></script>
	    <script type="text/javascript" src="../ace-editor/ace-builds/src-noconflict/ace.js" charset="utf-8"></script>
	    <!--script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script-->
	    <script type="text/javascript" src="d3.min.js"></script>
	    <script type="text/javascript" src="../cola/highlight.pack.js"></script>
        <script type="text/javascript" src="../cola/cola.v1.min.js"></script>
        <script type="text/javascript" src="../graphlib-dot/graphlib-dot.min.js"></script>

        <!-- internal libraries -->
        <script type="text/javascript" src="dataflow.js"></script>
        <script type="text/javascript" src="datamodel.js"></script>
        <script type="text/javascript" src="editor.js" charset="utf-8"></script>
        <script type="text/javascript" src="read-input-files.js"></script>
        <script type="text/javascript" src="timeline.js"></script>

        <!-- temporary dependencies -->
        <!--script type="text/javascript" src="../../HelloSimpleCompiler.deg"></script>
        <script type="text/javascript" src="profileData.js"></script-->

        <!--script type="text/javascript" src="testDeg.deg"></script>
        <script type="text/javascript" src="testProfileData.js"></script-->

        <script type="text/javascript" src="David_app/RNTNCompiler.deg"></script>
        <script type="text/javascript" src="David_app/profileData.js"></script>

	    <script type="text/javascript">
	    	var viewState = {}
	    	viewState.highlightedGraphNode = -1
	    	viewState.appSourceFileName = ""
	    	viewState.degFile = ""
	    	viewState.profileDataFile = ""
	    	viewState.highlightedLine = new aceRange(0,0,0,0)
	    	viewState.graphViewMode = $("#colorSchemeForGraph").val()
	    	viewState.selectedLevel = -1

	    	var config = {}
	    	config.markGraphNode = markGraphNode
	    	config.markNeighborsOnGraph = markNeighborsOnGraph
	    	config.highlightLineInEditor = highlightLineInEditor
	    	config.populateKernelInfoTable = populateKernelInfoTable
	    	config.populateSyncNodeInfoTable = populateSyncNodeInfoTable
	    	config.syncNodeRegex = /__sync-ExecutionThread-(\d+)-(.*)-(.*)-(\d+)$/
	    	config.re_partition = /^(.*)_(\d+)$/
			config.re_header = /^(.*)_h$/

	      	addAppSourceFileHandler("srcDirInput", editor)
	      	addDegFileHandler("degFileInput")
	      	addProfileDataFileHandler("profDataInput")

	      	var editor = {}
	      	var profData = {}
	      	var graphController = {}
	      	var timelineController = {}

	      	$("#colorSchemeForGraph").change(function() {
	      		var colorScheme = $(this).val()
	      		graphController.changeColoringScheme(colorScheme)
	      		viewState.graphViewMode = colorScheme
	      	})

	      	$('#timelineZoom').keyup(function(event){
			    if(event.keyCode == 13){
			        timelineController.zoom($(this).val() / 100)
			    }
			})

	      	$("#timelineLevelFilter").change(filterNodesOnTimeline)
	      	$('#startButton').click(startDebugSession)

	      	/*
			$(document).ready(function () {
				/*
				$('#accordian > ul > li').click(function() {
					$("#accordian ul li").removeClass("active")
				    $(this).addClass("active")

				    var checkElement = $(this).next()
				    if ((checkElement.is("ul")) && (checkElement.is(":visible"))) {
				        return false
				    }
				    if ((checkElement.is('ul')) && (!checkElement.is(':visible'))) {
				        $("#accordian ul:visible").slideUp("normal")
				        checkElement.slideDown("normal")
				        return false
				    }
			  	})
			})
			*/
			
			console.time("Start debug session")
			startDebugSession()
			console.timeEnd("Start debug session")

			function startDebugSession() {
				degOps = deg.DEG.ops
				//if ((viewState.degFile != "") && (viewState.profileDataFile != "")) {
					editor = createEditor("code")
					console.time("Compute profile data")
		      		profData = getProfileData(degOps, profileData.Profile, config)
		      		console.timeEnd("Compute profile data")

		      		console.time("Initialize graph")
		      		graphController = createDataFlowGraph(cola, "#dfg", profData.dependencyData, viewState, config)
		      		console.timeEnd("Initialize graph")

		      		console.time("Initialize timeline view")
			      	timelineController = createTimeline("#timeline", profData, config)
			      	console.timeEnd("Initialize timeline view")

			      	console.time("Filter timeline nodes")
			      	filterNodesOnTimeline()
			      	console.timeEnd("Filter timeline nodes")
			    /*
			    } else {
			    	alert("Please upload the DEG file and the profile data (profData.js) and retry")
			    }
			    //*/
			}

			function filterNodesOnTimeline() {
				var selectedLevel = parseInt($("#timelineLevelFilter").val())
	      		console.log(selectedLevel)
	      		for (var i = 0; i < 4; i++) {
	      			var filter = "level=level-" + i
	      			if (i != selectedLevel) {
			      		timelineController.hideNodes("text[" + filter + "]")
			      		timelineController.hideNodes("rect[" + filter + "]")
	      			} else {
	      				timelineController.showNodes("text[" + filter + "]")
			      		timelineController.showNodes("rect[" + filter + "]")
	      			}
	      		}

	      		viewState.selectedLevel = selectedLevel
			}

	    	function markGraphNode(kernelId) {
	    		var n = viewState.highlightedGraphNode
	    		if (n != -1) {
	    			graphController.unhighlightNode(n)
	    		}

	    		graphController.highlightNode(kernelId)
	    		viewState.highlightedGraphNode = kernelId
	    	}

	    	function markNeighborsOnGraph(nodeId) {
	    		graphController.markNeighbors(nodeId)
	    	}

	    	function highlightLineInEditor(file, line) {
	    		unhighlightLine(viewState.highlightedLine)
	    		if (file in fileNameToFile) {
	    			if (file != viewState.appSourceFileName) readFile(file)
					viewState.highlightedLine = highlightLine(line)
					viewState.appSourceFileName = file
	    		} else {
	    			console.log("WARNING: Selected kernel's sourceContext does not match the source file being viewed")
	    		}
	    	}

	    	function populateKernelInfoTable(node) {
	    		var values = [node.name, node.type, node.target, node.percentage_time.toFixed(2) + " %", node.execTime.pct.toFixed(0) + "/" + node.syncTime.pct.toFixed(0) + " %", node.memUsage + " B"]
	    		var table = $("#kernelInfoTable")[0]
	    		values.forEach(function(v, i) {
	    			var row = table.rows[i + 1]
	    			row.cells[1].innerHTML = values[i]
	    		})
	    	}

	    	function populateSyncNodeInfoTable(node) {
	    		var properties = ["Dep. Thread", "Dep. Kernel", "Time (%)"]
	    		var values = [node.dep_thread, node.dep_kernel, "NA"]
	    		var table = $("#syncNodeInfoTable")[0]
	    		properties.forEach(function(p, i) {
	    			var row = table.rows[i + 1]
	    			row.cells[1].innerHTML = values[i]
	    		})
	    	}
		</script>
	</body>	
</html>